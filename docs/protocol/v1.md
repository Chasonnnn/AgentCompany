# AgentCompany JSON-RPC Protocol v1 (Local Stdio)

This document defines the v1 control-plane contract for local clients.

## Transport

- Protocol: JSON-RPC 2.0
- Framing: one JSON object per line (`\n` delimited)
- Direction: bidirectional over stdio
- Server command: `ac server:start`

## Request/Response

Requests:

```json
{"jsonrpc":"2.0","id":1,"method":"run.list","params":{"workspace_dir":"/path/to/ws"}}
```

Success:

```json
{"jsonrpc":"2.0","id":1,"result":[{"project_id":"proj_x","run_id":"run_x"}]}
```

Error:

```json
{"jsonrpc":"2.0","id":1,"error":{"code":-32602,"message":"Invalid params","data":[...]}}
```

## Notification Stream

Server notifications use:

```json
{"jsonrpc":"2.0","method":"events.notification","params":{"subscription_id":"sub_x","project_id":"proj_x","event":{...}}}
```

`event` payload mirrors persisted run events from `events.jsonl`.

Run lifecycle streams may include usage events:

- `usage.reported`: provider-reported token counters extracted from structured provider output
- `usage.estimated`: deterministic fallback estimated from character counts when provider usage is unavailable

Terminal `run.yaml` now includes optional `usage` with normalized token counters and confidence.

Provider note:
- Claude driver now runs with `--output-format stream-json`; clients should expect `provider.raw` chunks to include JSONL stream events.
- Gemini CLI worker runs now default to headless JSON mode (`--output-format json -p <prompt>`).
- Gemini API-channel policy preflight can block launch before execution when API credentials are missing.

## Event Envelope (Persisted)

Run events persisted in `events.jsonl` use this envelope:

- `schema_version`
- `event_id`
- `correlation_id`
- `causation_id`
- `ts_wallclock`
- `ts_monotonic_ms`
- `run_id`
- `session_ref`
- `actor`
- `visibility`
- `type`
- `payload`
- `prev_event_hash`
- `event_hash`

`event_hash` and `prev_event_hash` form a per-file hash chain for tamper/corruption detection.

## Supported Methods (v1)

Workspace:

- `system.capabilities`
- `workspace.open`
- `workspace.init`
- `workspace.validate`
- `workspace.doctor`
- `workspace.diagnostics`
- `workspace.migrate`
- `workspace.export`
- `workspace.import`
- `workspace.projects.list`
- `workspace.agents.list`
- `workspace.teams.list`
- `workspace.project.create_with_defaults`
- `workspace.project.link_repo`
- `workspace.repo_root.set`
- `workspace.bootstrap.enterprise`
- `workspace.home.snapshot`
- `desktop.bootstrap.snapshot`

Run/session:

- `worktree.cleanup`
- `run.create`
- `run.list`
- `run.replay`
- `sharepack.replay`
- `session.launch`
- `session.list`
- `session.poll`
- `session.collect`
- `session.stop`
- `job.submit`
- `job.list`
- `job.poll`
- `job.collect`
- `job.cancel`
- `heartbeat.status`
- `heartbeat.tick`
- `heartbeat.config.get`
- `heartbeat.config.set`
- `pipeline.client_intake.run`
- `pipeline.department.assign_tasks`

Inbox/governance:

- `inbox.list_reviews`
- `inbox.list_help_requests`
- `inbox.snapshot`
- `inbox.resolve`
- `artifact.read`
- `context.plan_for_job`
- `memory.propose_delta`
- `memory.approve_delta`
- `memory.list_deltas`
- `memory.extract_candidates`
- `milestone.approve`
- `agent.record_mistake`
- `agent.self_improve_cycle`
- `agent.refresh_context`

Adapters:

- `adapter.status`

Index/cache:

- `index.rebuild`
- `index.sync`
- `index.stats`
- `index.sync_worker_status`
- `index.sync_worker_flush`
- `index.list_runs`
- `index.list_events`
- `index.list_event_parse_errors`
- `index.list_reviews`
- `index.list_help_requests`

Run monitor:

- `monitor.snapshot`
- `usage.analytics`
- `ui.snapshot`
- `ui.resolve`
- `comment.add`
- `comment.list`
- `resources.snapshot`
- `agent.profile.snapshot`

Conversations:

- `conversation.list`
- `conversation.create_channel`
- `conversation.create_dm`
- `conversation.messages.list`
- `conversation.message.send`
- `conversation.members.sync`

Tasks + PM:

- `task.list`
- `task.update_plan`
- `pm.snapshot`
- `pm.recommend_allocations`
- `pm.apply_allocations`

Event subscriptions:

- `events.subscribe`
- `events.unsubscribe`
- `events.ack`

## Event Subscription Params

`events.subscribe` params:

- `subscription_id` (optional)
- `workspace_dir` (optional; required for indexed backfill)
- `project_id` (optional filter)
- `run_id` (optional filter)
- `event_types` (optional array filter)
- `backfill_limit` (optional; if provided with `workspace_dir`, server runs incremental index sync then replays recent events in ascending order)

`events.unsubscribe` params:

- `subscription_id` (required)

`events.ack` params:

- `subscription_id` (required)
- `last_ack_ts_monotonic_ms` (optional)

`monitor.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`usage.analytics` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`workspace.doctor` params:

- `workspace_dir` (required)
- `rebuild_index` (optional; full rebuild check/fix)
- `sync_index` (optional; incremental sync check/fix)

`workspace.diagnostics` params:

- `workspace_dir` (required)
- `out_dir` (required)
- `rebuild_index` (optional; full rebuild before snapshot capture)
- `sync_index` (optional; incremental sync before snapshot capture, default true)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)

`workspace.migrate` params:

- `workspace_dir` (required)
- `dry_run` (optional; default false)
- `force` (optional; default false)

`workspace.export` params:

- `workspace_dir` (required)
- `out_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`workspace.import` params:

- `src_dir` (required)
- `workspace_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`workspace.projects.list` params:

- `workspace_dir` (required)

`workspace.agents.list` params:

- `workspace_dir` (required)
- `role` (optional)
- `team_id` (optional)

`workspace.teams.list` params:

- `workspace_dir` (required)

`workspace.project.create_with_defaults` params:

- `workspace_dir` (required)
- `name` (required)
- `ceo_actor_id` (optional)
- `executive_manager_agent_id` (optional)
- `repo_ids` (optional)

`workspace.project.link_repo` params:

- `workspace_dir` (required)
- `project_id` (required)
- `repo_id` (required)
- `label` (optional)

`workspace.repo_root.set` params:

- `workspace_dir` (required)
- `repo_id` (required)
- `repo_path` (required; machine-local absolute path)
- `require_git` (optional; default `true`)

`workspace.bootstrap.enterprise` params:

- `workspace_dir` (required)
- `company_name` (optional; default `AgentCompany`)
- `project_name` (optional; default `AgentCompany Ops`)
- `org_mode` (`enterprise|standard`, optional; default `enterprise`)
- `executive_manager_name` (optional; default `Executive Manager`)
- `departments` (optional array of department keys)
- `workers_per_dept` (optional integer; default `1`, min `1`)
- `include_ceo` (optional boolean; default `true`)
- `include_director` (optional boolean; applies to `standard` mode)
- `force` (optional boolean; reset controlled workspace roots before bootstrap)

Enterprise bootstrap provider defaults:
- Executive Manager is created as a `manager` with `provider=gemini` (API-channel usage billing).
- Department directors/workers use preset CLI-oriented providers (`codex` / `claude_code`) for subscription-authenticated execution.

Enterprise default departments:
- `frontend`
- `backend`
- `agent_resources`
- `marketing`
- `infra`
- `data`

`pipeline.client_intake.run` params:

- `workspace_dir` (required)
- `project_name` (required)
- `ceo_actor_id` (required)
- `executive_manager_agent_id` (required)
- `intake_text` (optional)
- `intake_file` (optional; mutually exclusive with `intake_text`)
- `model` (optional model override)

Result includes:
- `project_id`
- `artifacts` (`intake_brief_artifact_id`, `executive_plan_artifact_id`, `meeting_transcript_artifact_id`, `approval_artifact_id`)
- `department_plan_artifact_ids`
- `director_task_ids`
- `assigned_task_ids`
- `meeting_conversation_id`
- `generation`:
  - `mode` (`deterministic|provider_with_fallback`)
  - `attempted` (provider fill attempts)
  - `succeeded` (provider fill successes)
  - `failed` (provider fill failures)
  - `failure_artifact_ids` (provider failure artifact ids when emitted)
  - `audit_log_relpath` (JSONL audit log under `work/projects/<project_id>/logs/`)

Generation semantics:
- If `model` is omitted, deterministic scaffolding is used and provider fill is skipped.
- If `model` is provided, provider fill is attempted for executive plan, planning-council transcript, and each department plan.
- Provider failure never aborts intake; deterministic baseline artifacts remain canonical and failures are audited.

`pipeline.department.assign_tasks` params:

- `workspace_dir` (required)
- `project_id` (required)
- `department_key` (required)
- `director_agent_id` (required)
- `worker_agent_ids` (required array, min `1`)
- `approved_executive_plan_artifact_id` (required; must reference `executive_plan`)

Assignment gate semantics:
- Worker task creation requires a linked CEO approval for the executive plan.
- A valid gate is an approved review where:
  - `subject.kind === heartbeat_action`
  - reviewer role is `ceo` or `human`
  - reviewed proposal links to `approved_executive_plan_artifact_id` (rationale/idempotency linkage)
- Missing linkage returns an actionable error (`CEO approval required for executive plan <id>`).

Result includes:
- `created_task_ids`
- `created_milestone_ids`
- `assignment_map` (worker -> task)
- `denied_assignments`
- `audit_log_relpath`

`heartbeat.config.set` enterprise hierarchy extensions:

- `hierarchy_mode` (`standard|enterprise_v1`)
- `executive_manager_agent_id` (optional)
- `allow_director_to_spawn_workers` (optional boolean)

Launch-action extensions in heartbeat worker reports:
- `job_kind` (`execution|heartbeat`, optional)
- `target_role` (`director|worker`, optional)

Artifact type additions (schema v1, no destructive migration required):
- `meeting_transcript`
- `department_plan`
- `executive_plan`

Team metadata additions (optional, backward-compatible):
- `department_key`
- `department_label`
- `charter`

`workspace.home.snapshot` params:

- `workspace_dir` (required)

Result includes `pm` payload with portfolio summary (`project_count`, `progress_pct`, `blocked_projects`, etc.) and per-project PM rows.

`desktop.bootstrap.snapshot` params:

- `workspace_dir` (required)
- `actor_id` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required when `scope=project`)
- `view` (`home|activities|resources|conversation`, required)
- `conversation_id` (required when `view=conversation`)

`desktop.bootstrap.snapshot` response:

- `projects`: result-compatible with `workspace.projects.list` (includes `active_runs`, `pending_reviews`, `blocked_tasks`, `progress_pct`)
- `agents`: result-compatible with `workspace.agents.list`
- `teams`: result-compatible with `workspace.teams.list`
- `conversations`: result-compatible with `conversation.list`
- `view_data`:
  - `home`: `{ workspace_home, pm, resources, recommendations[] }`
  - `activities`: `{ ui }`
  - `resources`: `{ resources }`
  - `conversation`: `{ messages }`
- `resources_summary`: aggregate totals for current scope resources snapshot
- `activity_summary`: `{ pending_reviews, recent_decisions, monitor_rows }`
- `pm_summary`: workspace PM summary (`project_count`, `progress_pct`, `blocked_projects`, `active_runs`, `pending_reviews`)
- `sync_ts`: ISO timestamp generated for the bundle

`worktree.cleanup` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `max_age_hours` (optional; default 72)
- `dry_run` (optional; default false)

`index.sync_worker_status` params:

- none

`index.sync_worker_flush` params:

- none

`inbox.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

Enterprise executive-plan approvals are surfaced as pending `heartbeat_action_proposal` items and are typically consumed by project-home approval UI flows.

`inbox.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)

`inbox.resolve` supports these artifact types:
- `memory_delta`
- `milestone_report`
- `heartbeat_action_proposal` (subject_kind: `heartbeat_action`)

`system.capabilities` params:

- none

`system.capabilities` result highlights:

- `available_methods` (method names guaranteed by this server build)
- `context.layers_version` (`1` for L0/L1/L2 planner contract)
- `context.job_submit_auto_default` (`true` when `job.submit` defaults to auto context mode)
- `memory.write_schema_version` (current writer schema)
- `memory.parse_supported` (memory delta schema versions accepted by parser)
- `memory.list_requires_actor` (whether list API requires actor context)
- `memory.session_candidate_mode` (`review_only` for memory candidate extraction)
- `retrieval.storage` (`sqlite_metadata` in v1)

`memory.propose_delta` params:

- `workspace_dir` (required)
- `project_id` (required)
- `title` (required)
- `scope_kind` (`project_memory|agent_guidance`, required)
- `scope_ref` (required when `scope_kind=agent_guidance`; ignored for `project_memory`)
- `sensitivity` (`public|internal|restricted`, required)
- `rationale` (required)
- `under_heading` (required)
- `insert_lines` (required, non-empty string array)
- `visibility` (`private_agent|team|managers|org`, required)
- `produced_by` (required)
- `run_id` (required)
- `context_pack_id` (required)
- `evidence` (required, non-empty string array)

`memory.approve_delta` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`, required)
- `actor_team_id` (optional)
- `notes` (optional)

`memory.list_deltas` params:

- `workspace_dir` (required)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`, required)
- `actor_team_id` (optional)
- `project_id` (optional filter)
- `status` (`pending|approved|denied|all`, optional; default `all`)
- `limit` (optional; max 5000)

`memory.list_deltas` result highlights:

- `count`
- `filtered_by_policy_count` (rows omitted by policy filtering for the caller)
- `items[*].source_schema_version` (`1|2`)

`context.plan_for_job` params:

- `workspace_dir` (required)
- `project_id` (required)
- `worker_agent_id` (optional)
- `manager_actor_id` (required)
- `manager_role` (`human|ceo|director|manager|worker`, required)
- `manager_team_id` (optional)
- `job_kind` (`execution|heartbeat`, optional; default `execution`)
- `goal` (required)
- `constraints` (optional string array)
- `deliverables` (optional string array)
- `context_refs` (optional seed refs `[{kind,value,description?}]`)
- `max_refs` (optional; max 200)

`context.plan_for_job` result highlights:

- `context_refs` (planned refs after policy/sensitivity/secret filters)
- `layers_used` (`L0|L1|L2` present in selected refs)
- `retrieval_trace` (include/exclude decisions for auditability)
- `filtered_by_policy_count`
- `filtered_by_sensitivity_count`
- `filtered_by_secret_count`

`memory.extract_candidates` params:

- `workspace_dir` (required)
- `project_id` (required)
- `job_id` (optional; required when `run_id` omitted)
- `run_id` (optional; required when `job_id` omitted)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`, required)
- `actor_team_id` (optional)
- `limit` (optional; max 100)

`memory.extract_candidates` result highlights:

- `report_relpath` (written under `runs/<run_id>/outputs/memory_candidates.json`)
- `count` (accepted candidate count)
- `blocked_secret_count` (secret-filtered candidate count)
- `candidates` (review-only proposal suggestions; no memory mutation)

Memory parser invariants:

- Accepts only `schema_version` `1` or `2` for `memory_delta`.
- Fails closed on unknown frontmatter fields (strict schema parse).

`session.poll` / `session.collect` / `session.stop` params:

- `session_ref` (required)
- `workspace_dir` (optional; needed when resolving persisted sessions after runtime restart)

`job.submit` params:

- `job` (required `JobSpec` object)
  - `job_id`
  - `job_kind` (`execution|heartbeat`, optional; default `execution`)
  - `context_mode` (`auto|manual`, optional; default behavior is `auto`)
  - `worker_kind` (`codex|claude|gemini`)
  - `workspace_dir`
  - `project_id`
  - `goal`
  - `constraints` (string[])
  - `deliverables` (string[])
  - `permission_level` (`read-only|patch|run-commands`)
  - `context_refs` (`[{kind,value,description?}]`)
  - `max_context_refs` (optional; max 200)
  - optional: `worker_agent_id`, `model`, `manager_actor_id`, `manager_role`, `manager_team_id`

`job.submit` auto-context semantics:

- In `context_mode=auto`, server performs layered context planning before worker execution.
- Auto mode requires `manager_actor_id` + `manager_role`; missing actor context is rejected fail-closed.
- Planned refs are merged with seed refs (`context_refs`) and deduplicated by `(kind,value)`.
- Attempt metadata includes `context_plan_relpath` and `context_plan_hash` when a plan is persisted.

`job.list` params:

- `workspace_dir` (required)
- `project_id` (required)
- `status` (`queued|running|completed|canceled`, optional)
- `limit` (optional)

`job.poll` / `job.collect` / `job.cancel` params:

- `workspace_dir` (required)
- `project_id` (required)
- `job_id` (required)

`job.collect` result:
- includes `result` and `manager_digest` when available
- includes optional `heartbeat_report` when `job_kind=heartbeat`

`heartbeat.status` params:

- `workspace_dir` (required)

`heartbeat.status` result highlights:

- scheduler/runtime state (`observed`, `loop_running`, `tick_in_progress`, `next_scheduled_at`)
- effective heartbeat `config`
- durable heartbeat `state` (`last_tick_at`, `next_tick_at`, cursors, suppression, idempotency, stats)

`heartbeat.tick` params:

- `workspace_dir` (required)
- `dry_run` (optional)
- `reason` (optional)

`heartbeat.tick` result highlights:

- `tick_id`, timestamps, `duration_ms`
- candidate worker scores and selected `woken_workers`
- `woken_workers[].project_id` is populated when project routing resolves from triage signals
- worker reports processed counts (`reports_ok`, `reports_actions`)
- action arbitration counts (`actions_executed`, `approvals_queued`, `deduped_actions`, `skipped_actions`)

Project routing semantics for wake targets:
- First choice: triage-provided signal-routed project.
- Fallback: worker's latest indexed run project.
- Final fallback: workspace global default project.

`heartbeat.config.get` params:

- `workspace_dir` (required)

`heartbeat.config.set` params:

- `workspace_dir` (required)
- partial heartbeat config fields (all optional):
  - `enabled`
  - `tick_interval_minutes`
  - `top_k_workers`
  - `min_wake_score`
  - `ok_suppression_minutes`
  - `due_horizon_minutes`
  - `max_auto_actions_per_tick`
  - `max_auto_actions_per_hour`
  - `quiet_hours_start_hour`
  - `quiet_hours_end_hour`
  - `stuck_job_running_minutes`
  - `idempotency_ttl_days`
  - `jitter_max_seconds`

`session.launch` params (lane scheduler options):

- `workspace_dir` (required)
- `project_id` (required)
- `run_id` (required)
- `argv` (optional)
- `repo_id` (optional)
- `workdir_rel` (optional)
- `task_id` (optional)
- `milestone_id` (optional)
- `prompt_text` (optional)
- `model` (optional)
- `budget` (optional)
- `stdin_text` (optional)
- `env` (optional)
- `session_ref` (optional)
- `lane_priority` (`high|normal|low`, optional; default `normal`)
- `lane_workspace_limit` (optional)
- `lane_provider_limit` (optional)
- `lane_team_limit` (optional)
- `actor_id` (optional; default `human`)
- `actor_role` (`human|ceo|director|manager|worker`, optional; default `human`)
- `actor_team_id` (optional)

Launch semantics:

- `session.launch` enforces policy at launch time (`policy.decision` / `policy.denied` events).
- Budget preflight/advisory decisions are emitted before spawn (`budget.decision|budget.alert|budget.exceeded` with `phase=preflight`).
- Hard preflight budget exceedance marks the run failed and returns a launch error.

`run.replay` params:

- `workspace_dir` (required)
- `project_id` (required)
- `run_id` (required)
- `tail` (optional)
- `mode` (`raw|verified|deterministic|live`, optional; default `raw`)

`sharepack.replay` params:

- `workspace_dir` (required)
- `project_id` (required)
- `share_pack_id` (required)
- `run_id` (optional)
- `tail` (optional)
- `mode` (`raw|verified|deterministic`, optional; default `raw`)

`ui.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`ui.snapshot` response highlights:

- `index_sync_worker` runtime status
- `heartbeat` summary block (enabled/running, interval/top-k config, last/next tick, aggregate counters)
- `monitor`, `review_inbox`, `usage_analytics`, `colleagues`, `comments`

`ui.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`ui.resolve` is the desktop approval action used for inbox-driven executive-plan approve/deny decisions (resolving pending `heartbeat_action_proposal` items).

`agent.refresh_context` params:

- `workspace_dir` (required)
- `agent_id` (required)
- `project_id` (optional filter)
- `max_tasks` (optional)
- `max_scope_paths` (optional)

`agent.self_improve_cycle` params:

- `workspace_dir` (required)
- `project_id` (required)
- `worker_agent_id` (required)
- `manager_actor_id` (required)
- `manager_role` (`human|ceo|director|manager|worker`)
- `mistake_key` (required)
- `summary` (required)
- `prevention_rule` (required)
- `proposal_threshold` (optional; integer >= 1)
- `promote_threshold` (optional; integer >= 1)
- `evidence_artifact_ids` (optional)
- `task_id` (optional)
- `milestone_id` (optional)
- `evaluation_argv` (optional command argv list for gate evaluation)
- `evaluation_repo_id` (optional)
- `evaluation_workdir_rel` (optional)
- `evaluation_env` (optional string map)

Result semantics:

- `status` can be:
  - `recorded_only` (mistake count below proposal threshold)
  - `already_guided` (worker AGENTS rule already present)
  - `evaluation_failed` (evaluation gate failed; failure artifact written)
  - `proposal_created` (pending memory delta proposal created for director+ approval)

`comment.add` params:

- `workspace_dir` (required)
- `project_id` (required)
- `author_id` (required)
- `author_role` (`human|ceo|director|manager|worker`)
- `body` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `visibility` (optional; default `managers`)

`comment.list` params:

- `workspace_dir` (required)
- `project_id` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `limit` (optional)

`resources.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional)

`resources.snapshot` response highlights:

- `totals` includes `agents`, `workers`, `active_workers`, `runs_indexed`, token/cost totals, and provider-aware context-cycle totals
- `providers[]` includes `provider`, `run_count`, `total_tokens`, `total_cost_usd`
- `models[]` includes `model`, `agent_count`

`agent.profile.snapshot` params:

- `workspace_dir` (required)
- `agent_id` (required)
- `project_id` (optional)

`agent.profile.snapshot` response highlights:

- `agent` includes profile fields (`display_title`, `avatar`, `model_hint`) and `tenure_days`
- `metrics.context_cycles_count` is nullable
- `metrics.context_cycles_source` is `provider_signal|unknown`; clients must render unknown rather than fabricating values

`conversation.list` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)

`conversation.create_channel` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `name` (required)
- `slug` (required)
- `visibility` (optional)
- `created_by` (required)
- `participant_agent_ids` (optional)
- `participant_team_ids` (optional)

`conversation.create_dm` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `created_by` (required)
- `peer_agent_id` (required)
- `visibility` (optional)

`conversation.messages.list` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `conversation_id` (required)
- `limit` (optional)

`conversation.message.send` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `conversation_id` (required)
- `author_id` (required)
- `author_role` (required)
- `body` (required)
- `kind` (optional)
- `visibility` (optional)
- `mentions` (optional)

`conversation.members.sync` params:

- `workspace_dir` (required)
- `project_id` (required)
- `ceo_actor_id` (optional)

`task.list` params:

- `workspace_dir` (required)
- `project_id` (required)

`task.update_plan` params:

- `workspace_dir` (required)
- `project_id` (required)
- `task_id` (required)
- `schedule` (optional)
- `schedule.planned_start` (optional ISO datetime)
- `schedule.planned_end` (optional ISO datetime)
- `schedule.duration_days` (optional positive integer)
- `schedule.depends_on_task_ids` (optional string array)
- `execution_plan` (optional)
- `execution_plan.preferred_provider` (optional)
- `execution_plan.preferred_model` (optional)
- `execution_plan.preferred_agent_id` (optional)
- `execution_plan.token_budget_hint` (optional non-negative integer)
- `execution_plan.applied_by` (optional)
- `execution_plan.applied_at` (optional ISO datetime)
- `clear_schedule` (optional boolean)
- `clear_execution_plan` (optional boolean)

`pm.snapshot` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)

`pm.snapshot` response highlights:

- workspace scope includes portfolio summary and project PM rows
- project scope additionally includes:
  - `project.summary` (task counts + progress)
  - `project.gantt.cpm_status` (`ok|dependency_cycle`)
  - `project.gantt.tasks[]` task bars (`start_at`, `end_at`, `duration_days`, `slack_days`, `critical`)
- dependency cycles are surfaced in payload as status flags; snapshot generation does not crash

`pm.recommend_allocations` params:

- `workspace_dir` (required)
- `project_id` (required)

`pm.apply_allocations` params:

- `workspace_dir` (required)
- `project_id` (required)
- `applied_by` (required)
- `items` (required array)
- `items[].task_id` (required)
- `items[].preferred_provider` (optional)
- `items[].preferred_model` (optional)
- `items[].preferred_agent_id` (optional)
- `items[].token_budget_hint` (optional)

## Error Codes

- `-32700`: Parse error
- `-32600`: Invalid request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32000`: Application error
