# AgentCompany JSON-RPC Protocol v1 (Local Stdio)

This document defines the v1 control-plane contract for local clients.

## Transport

- Protocol: JSON-RPC 2.0
- Framing: one JSON object per line (`\n` delimited)
- Direction: bidirectional over stdio
- Server command: `ac server:start`

## Request/Response

Requests:

```json
{"jsonrpc":"2.0","id":1,"method":"run.list","params":{"workspace_dir":"/path/to/ws"}}
```

Success:

```json
{"jsonrpc":"2.0","id":1,"result":[{"project_id":"proj_x","run_id":"run_x"}]}
```

Error:

```json
{"jsonrpc":"2.0","id":1,"error":{"code":-32602,"message":"Invalid params","data":[...]}}
```

## Notification Stream

Server notifications use:

```json
{"jsonrpc":"2.0","method":"events.notification","params":{"subscription_id":"sub_x","project_id":"proj_x","event":{...}}}
```

`event` payload mirrors persisted run events from `events.jsonl`.

Run lifecycle streams may include usage events:

- `usage.reported`: provider-reported token counters extracted from structured provider output
- `usage.estimated`: deterministic fallback estimated from character counts when provider usage is unavailable

Terminal `run.yaml` now includes optional `usage` with normalized token counters and confidence.

Provider note:
- Claude driver now runs with `--output-format stream-json`; clients should expect `provider.raw` chunks to include JSONL stream events.

## Event Envelope (Persisted)

Run events persisted in `events.jsonl` use this envelope:

- `schema_version`
- `event_id`
- `correlation_id`
- `causation_id`
- `ts_wallclock`
- `ts_monotonic_ms`
- `run_id`
- `session_ref`
- `actor`
- `visibility`
- `type`
- `payload`
- `prev_event_hash`
- `event_hash`

`event_hash` and `prev_event_hash` form a per-file hash chain for tamper/corruption detection.

## Supported Methods (v1)

Workspace:

- `workspace.open`
- `workspace.init`
- `workspace.validate`
- `workspace.doctor`
- `workspace.diagnostics`
- `workspace.migrate`
- `workspace.export`
- `workspace.import`
- `workspace.projects.list`
- `workspace.agents.list`
- `workspace.project.create_with_defaults`
- `workspace.project.link_repo`
- `workspace.home.snapshot`

Run/session:

- `worktree.cleanup`
- `run.create`
- `run.list`
- `run.replay`
- `sharepack.replay`
- `session.launch`
- `session.list`
- `session.poll`
- `session.collect`
- `session.stop`

Inbox/governance:

- `inbox.list_reviews`
- `inbox.list_help_requests`
- `inbox.snapshot`
- `inbox.resolve`
- `artifact.read`
- `memory.propose_delta`
- `memory.approve_delta`
- `milestone.approve`
- `agent.record_mistake`
- `agent.self_improve_cycle`
- `agent.refresh_context`

Adapters:

- `adapter.status`

Index/cache:

- `index.rebuild`
- `index.sync`
- `index.stats`
- `index.sync_worker_status`
- `index.sync_worker_flush`
- `index.list_runs`
- `index.list_events`
- `index.list_event_parse_errors`
- `index.list_reviews`
- `index.list_help_requests`

Run monitor:

- `monitor.snapshot`
- `ui.snapshot`
- `ui.resolve`
- `comment.add`
- `comment.list`
- `resources.snapshot`
- `agent.profile.snapshot`

Conversations:

- `conversation.list`
- `conversation.create_channel`
- `conversation.create_dm`
- `conversation.messages.list`
- `conversation.message.send`
- `conversation.members.sync`

Event subscriptions:

- `events.subscribe`
- `events.unsubscribe`
- `events.ack`

## Event Subscription Params

`events.subscribe` params:

- `subscription_id` (optional)
- `workspace_dir` (optional; required for indexed backfill)
- `project_id` (optional filter)
- `run_id` (optional filter)
- `event_types` (optional array filter)
- `backfill_limit` (optional; if provided with `workspace_dir`, server runs incremental index sync then replays recent events in ascending order)

`events.unsubscribe` params:

- `subscription_id` (required)

`events.ack` params:

- `subscription_id` (required)
- `last_ack_ts_monotonic_ms` (optional)

`monitor.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`workspace.doctor` params:

- `workspace_dir` (required)
- `rebuild_index` (optional; full rebuild check/fix)
- `sync_index` (optional; incremental sync check/fix)

`workspace.diagnostics` params:

- `workspace_dir` (required)
- `out_dir` (required)
- `rebuild_index` (optional; full rebuild before snapshot capture)
- `sync_index` (optional; incremental sync before snapshot capture, default true)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)

`workspace.migrate` params:

- `workspace_dir` (required)
- `dry_run` (optional; default false)
- `force` (optional; default false)

`workspace.export` params:

- `workspace_dir` (required)
- `out_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`workspace.import` params:

- `src_dir` (required)
- `workspace_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`workspace.projects.list` params:

- `workspace_dir` (required)

`workspace.agents.list` params:

- `workspace_dir` (required)
- `role` (optional)
- `team_id` (optional)

`workspace.project.create_with_defaults` params:

- `workspace_dir` (required)
- `name` (required)
- `ceo_actor_id` (optional)
- `repo_ids` (optional)

`workspace.project.link_repo` params:

- `workspace_dir` (required)
- `project_id` (required)
- `repo_id` (required)
- `label` (optional)

`workspace.home.snapshot` params:

- `workspace_dir` (required)

`worktree.cleanup` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `max_age_hours` (optional; default 72)
- `dry_run` (optional; default false)

`index.sync_worker_status` params:

- none

`index.sync_worker_flush` params:

- none

`inbox.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`inbox.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)

`session.poll` / `session.collect` / `session.stop` params:

- `session_ref` (required)
- `workspace_dir` (optional; needed when resolving persisted sessions after runtime restart)

`session.launch` params (lane scheduler options):

- `workspace_dir` (required)
- `project_id` (required)
- `run_id` (required)
- `argv` (optional)
- `repo_id` (optional)
- `workdir_rel` (optional)
- `task_id` (optional)
- `milestone_id` (optional)
- `prompt_text` (optional)
- `model` (optional)
- `budget` (optional)
- `stdin_text` (optional)
- `env` (optional)
- `session_ref` (optional)
- `lane_priority` (`high|normal|low`, optional; default `normal`)
- `lane_workspace_limit` (optional)
- `lane_provider_limit` (optional)
- `lane_team_limit` (optional)
- `actor_id` (optional; default `human`)
- `actor_role` (`human|ceo|director|manager|worker`, optional; default `human`)
- `actor_team_id` (optional)

Launch semantics:

- `session.launch` enforces policy at launch time (`policy.decision` / `policy.denied` events).
- Budget preflight/advisory decisions are emitted before spawn (`budget.decision|budget.alert|budget.exceeded` with `phase=preflight`).
- Hard preflight budget exceedance marks the run failed and returns a launch error.

`run.replay` params:

- `workspace_dir` (required)
- `project_id` (required)
- `run_id` (required)
- `tail` (optional)
- `mode` (`raw|verified|deterministic|live`, optional; default `raw`)

`sharepack.replay` params:

- `workspace_dir` (required)
- `project_id` (required)
- `share_pack_id` (required)
- `run_id` (optional)
- `tail` (optional)
- `mode` (`raw|verified|deterministic`, optional; default `raw`)

`ui.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`ui.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`agent.refresh_context` params:

- `workspace_dir` (required)
- `agent_id` (required)
- `project_id` (optional filter)
- `max_tasks` (optional)
- `max_scope_paths` (optional)

`agent.self_improve_cycle` params:

- `workspace_dir` (required)
- `project_id` (required)
- `worker_agent_id` (required)
- `manager_actor_id` (required)
- `manager_role` (`human|ceo|director|manager|worker`)
- `mistake_key` (required)
- `summary` (required)
- `prevention_rule` (required)
- `proposal_threshold` (optional; integer >= 1)
- `promote_threshold` (optional; integer >= 1)
- `evidence_artifact_ids` (optional)
- `task_id` (optional)
- `milestone_id` (optional)
- `evaluation_argv` (optional command argv list for gate evaluation)
- `evaluation_repo_id` (optional)
- `evaluation_workdir_rel` (optional)
- `evaluation_env` (optional string map)

Result semantics:

- `status` can be:
  - `recorded_only` (mistake count below proposal threshold)
  - `already_guided` (worker AGENTS rule already present)
  - `evaluation_failed` (evaluation gate failed; failure artifact written)
  - `proposal_created` (pending memory delta proposal created for manager approval)

`comment.add` params:

- `workspace_dir` (required)
- `project_id` (required)
- `author_id` (required)
- `author_role` (`human|ceo|director|manager|worker`)
- `body` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `visibility` (optional; default `managers`)

`comment.list` params:

- `workspace_dir` (required)
- `project_id` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `limit` (optional)

`resources.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional)

`agent.profile.snapshot` params:

- `workspace_dir` (required)
- `agent_id` (required)
- `project_id` (optional)

`conversation.list` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)

`conversation.create_channel` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `name` (required)
- `slug` (required)
- `visibility` (optional)
- `created_by` (required)
- `participant_agent_ids` (optional)
- `participant_team_ids` (optional)

`conversation.create_dm` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `created_by` (required)
- `peer_agent_id` (required)
- `visibility` (optional)

`conversation.messages.list` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `conversation_id` (required)
- `limit` (optional)

`conversation.message.send` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `conversation_id` (required)
- `author_id` (required)
- `author_role` (required)
- `body` (required)
- `kind` (optional)
- `visibility` (optional)
- `mentions` (optional)

`conversation.members.sync` params:

- `workspace_dir` (required)
- `project_id` (required)
- `ceo_actor_id` (optional)

## Error Codes

- `-32700`: Parse error
- `-32600`: Invalid request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32000`: Application error
