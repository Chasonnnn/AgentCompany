# AgentCompany JSON-RPC Protocol v1 (Local Stdio)

This document defines the v1 control-plane contract for local clients.

## Transport

- Protocol: JSON-RPC 2.0
- Framing: one JSON object per line (`\n` delimited)
- Direction: bidirectional over stdio
- Server command: `ac server:start`

## Request/Response

Requests:

```json
{"jsonrpc":"2.0","id":1,"method":"run.list","params":{"workspace_dir":"/path/to/ws"}}
```

Success:

```json
{"jsonrpc":"2.0","id":1,"result":[{"project_id":"proj_x","run_id":"run_x"}]}
```

Error:

```json
{"jsonrpc":"2.0","id":1,"error":{"code":-32602,"message":"Invalid params","data":[...]}}
```

## Notification Stream

Server notifications use:

```json
{"jsonrpc":"2.0","method":"events.notification","params":{"subscription_id":"sub_x","project_id":"proj_x","event":{...}}}
```

`event` payload mirrors persisted run events from `events.jsonl`.

Run lifecycle streams may include usage events:

- `usage.reported`: provider-reported token counters extracted from structured provider output
- `usage.estimated`: deterministic fallback estimated from character counts when provider usage is unavailable

Terminal `run.yaml` now includes optional `usage` with normalized token counters and confidence.

Provider note:
- Claude driver now runs with `--output-format stream-json`; clients should expect `provider.raw` chunks to include JSONL stream events.
- Gemini CLI worker runs now default to headless JSON mode (`--output-format json -p <prompt>`).
- Gemini API-channel policy preflight can block launch before execution when API credentials are missing.

## Event Envelope (Persisted)

Run events persisted in `events.jsonl` use this envelope:

- `schema_version`
- `event_id`
- `correlation_id`
- `causation_id`
- `ts_wallclock`
- `ts_monotonic_ms`
- `run_id`
- `session_ref`
- `actor`
- `visibility`
- `type`
- `payload`
- `prev_event_hash`
- `event_hash`

`event_hash` and `prev_event_hash` form a per-file hash chain for tamper/corruption detection.

## Supported Methods (v1)

Workspace:

- `workspace.open`
- `workspace.init`
- `workspace.validate`
- `workspace.doctor`
- `workspace.diagnostics`
- `workspace.migrate`
- `workspace.export`
- `workspace.import`
- `workspace.projects.list`
- `workspace.agents.list`
- `workspace.teams.list`
- `workspace.project.create_with_defaults`
- `workspace.project.link_repo`
- `workspace.home.snapshot`
- `desktop.bootstrap.snapshot`

Run/session:

- `worktree.cleanup`
- `run.create`
- `run.list`
- `run.replay`
- `sharepack.replay`
- `session.launch`
- `session.list`
- `session.poll`
- `session.collect`
- `session.stop`
- `job.submit`
- `job.list`
- `job.poll`
- `job.collect`
- `job.cancel`
- `heartbeat.status`
- `heartbeat.tick`
- `heartbeat.config.get`
- `heartbeat.config.set`

Inbox/governance:

- `inbox.list_reviews`
- `inbox.list_help_requests`
- `inbox.snapshot`
- `inbox.resolve`
- `artifact.read`
- `memory.propose_delta`
- `memory.approve_delta`
- `milestone.approve`
- `agent.record_mistake`
- `agent.self_improve_cycle`
- `agent.refresh_context`

Adapters:

- `adapter.status`

Index/cache:

- `index.rebuild`
- `index.sync`
- `index.stats`
- `index.sync_worker_status`
- `index.sync_worker_flush`
- `index.list_runs`
- `index.list_events`
- `index.list_event_parse_errors`
- `index.list_reviews`
- `index.list_help_requests`

Run monitor:

- `monitor.snapshot`
- `ui.snapshot`
- `ui.resolve`
- `comment.add`
- `comment.list`
- `resources.snapshot`
- `agent.profile.snapshot`

Conversations:

- `conversation.list`
- `conversation.create_channel`
- `conversation.create_dm`
- `conversation.messages.list`
- `conversation.message.send`
- `conversation.members.sync`

Tasks + PM:

- `task.list`
- `task.update_plan`
- `pm.snapshot`
- `pm.recommend_allocations`
- `pm.apply_allocations`

Event subscriptions:

- `events.subscribe`
- `events.unsubscribe`
- `events.ack`

## Event Subscription Params

`events.subscribe` params:

- `subscription_id` (optional)
- `workspace_dir` (optional; required for indexed backfill)
- `project_id` (optional filter)
- `run_id` (optional filter)
- `event_types` (optional array filter)
- `backfill_limit` (optional; if provided with `workspace_dir`, server runs incremental index sync then replays recent events in ascending order)

`events.unsubscribe` params:

- `subscription_id` (required)

`events.ack` params:

- `subscription_id` (required)
- `last_ack_ts_monotonic_ms` (optional)

`monitor.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`workspace.doctor` params:

- `workspace_dir` (required)
- `rebuild_index` (optional; full rebuild check/fix)
- `sync_index` (optional; incremental sync check/fix)

`workspace.diagnostics` params:

- `workspace_dir` (required)
- `out_dir` (required)
- `rebuild_index` (optional; full rebuild before snapshot capture)
- `sync_index` (optional; incremental sync before snapshot capture, default true)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)

`workspace.migrate` params:

- `workspace_dir` (required)
- `dry_run` (optional; default false)
- `force` (optional; default false)

`workspace.export` params:

- `workspace_dir` (required)
- `out_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`workspace.import` params:

- `src_dir` (required)
- `workspace_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`workspace.projects.list` params:

- `workspace_dir` (required)

`workspace.agents.list` params:

- `workspace_dir` (required)
- `role` (optional)
- `team_id` (optional)

`workspace.teams.list` params:

- `workspace_dir` (required)

`workspace.project.create_with_defaults` params:

- `workspace_dir` (required)
- `name` (required)
- `ceo_actor_id` (optional)
- `repo_ids` (optional)

`workspace.project.link_repo` params:

- `workspace_dir` (required)
- `project_id` (required)
- `repo_id` (required)
- `label` (optional)

`workspace.home.snapshot` params:

- `workspace_dir` (required)

Result includes `pm` payload with portfolio summary (`project_count`, `progress_pct`, `blocked_projects`, etc.) and per-project PM rows.

`desktop.bootstrap.snapshot` params:

- `workspace_dir` (required)
- `actor_id` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required when `scope=project`)
- `view` (`home|activities|resources|conversation`, required)
- `conversation_id` (required when `view=conversation`)

`desktop.bootstrap.snapshot` response:

- `projects`: result-compatible with `workspace.projects.list` (includes `active_runs`, `pending_reviews`, `blocked_tasks`, `progress_pct`)
- `agents`: result-compatible with `workspace.agents.list`
- `teams`: result-compatible with `workspace.teams.list`
- `conversations`: result-compatible with `conversation.list`
- `view_data`:
  - `home`: `{ workspace_home, pm, resources, recommendations[] }`
  - `activities`: `{ ui }`
  - `resources`: `{ resources }`
  - `conversation`: `{ messages }`
- `resources_summary`: aggregate totals for current scope resources snapshot
- `activity_summary`: `{ pending_reviews, recent_decisions, monitor_rows }`
- `pm_summary`: workspace PM summary (`project_count`, `progress_pct`, `blocked_projects`, `active_runs`, `pending_reviews`)
- `sync_ts`: ISO timestamp generated for the bundle

`worktree.cleanup` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `max_age_hours` (optional; default 72)
- `dry_run` (optional; default false)

`index.sync_worker_status` params:

- none

`index.sync_worker_flush` params:

- none

`inbox.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`inbox.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)

`inbox.resolve` supports these artifact types:
- `memory_delta`
- `milestone_report`
- `heartbeat_action_proposal` (subject_kind: `heartbeat_action`)

`session.poll` / `session.collect` / `session.stop` params:

- `session_ref` (required)
- `workspace_dir` (optional; needed when resolving persisted sessions after runtime restart)

`job.submit` params:

- `job` (required `JobSpec` object)
  - `job_id`
  - `job_kind` (`execution|heartbeat`, optional; default `execution`)
  - `worker_kind` (`codex|claude|gemini`)
  - `workspace_dir`
  - `project_id`
  - `goal`
  - `constraints` (string[])
  - `deliverables` (string[])
  - `permission_level` (`read-only|patch|run-commands`)
  - `context_refs` (`[{kind,value,description?}]`)
  - optional: `worker_agent_id`, `model`, `manager_actor_id`, `manager_role`

`job.list` params:

- `workspace_dir` (required)
- `project_id` (required)
- `status` (`queued|running|completed|canceled`, optional)
- `limit` (optional)

`job.poll` / `job.collect` / `job.cancel` params:

- `workspace_dir` (required)
- `project_id` (required)
- `job_id` (required)

`job.collect` result:
- includes `result` and `manager_digest` when available
- includes optional `heartbeat_report` when `job_kind=heartbeat`

`heartbeat.status` params:

- `workspace_dir` (required)

`heartbeat.status` result highlights:

- scheduler/runtime state (`observed`, `loop_running`, `tick_in_progress`, `next_scheduled_at`)
- effective heartbeat `config`
- durable heartbeat `state` (`last_tick_at`, `next_tick_at`, cursors, suppression, idempotency, stats)

`heartbeat.tick` params:

- `workspace_dir` (required)
- `dry_run` (optional)
- `reason` (optional)

`heartbeat.tick` result highlights:

- `tick_id`, timestamps, `duration_ms`
- candidate worker scores and selected `woken_workers`
- worker reports processed counts (`reports_ok`, `reports_actions`)
- action arbitration counts (`actions_executed`, `approvals_queued`, `deduped_actions`, `skipped_actions`)

`heartbeat.config.get` params:

- `workspace_dir` (required)

`heartbeat.config.set` params:

- `workspace_dir` (required)
- partial heartbeat config fields (all optional):
  - `enabled`
  - `tick_interval_minutes`
  - `top_k_workers`
  - `min_wake_score`
  - `ok_suppression_minutes`
  - `due_horizon_minutes`
  - `max_auto_actions_per_tick`
  - `max_auto_actions_per_hour`
  - `quiet_hours_start_hour`
  - `quiet_hours_end_hour`
  - `stuck_job_running_minutes`
  - `idempotency_ttl_days`
  - `jitter_max_seconds`

`session.launch` params (lane scheduler options):

- `workspace_dir` (required)
- `project_id` (required)
- `run_id` (required)
- `argv` (optional)
- `repo_id` (optional)
- `workdir_rel` (optional)
- `task_id` (optional)
- `milestone_id` (optional)
- `prompt_text` (optional)
- `model` (optional)
- `budget` (optional)
- `stdin_text` (optional)
- `env` (optional)
- `session_ref` (optional)
- `lane_priority` (`high|normal|low`, optional; default `normal`)
- `lane_workspace_limit` (optional)
- `lane_provider_limit` (optional)
- `lane_team_limit` (optional)
- `actor_id` (optional; default `human`)
- `actor_role` (`human|ceo|director|manager|worker`, optional; default `human`)
- `actor_team_id` (optional)

Launch semantics:

- `session.launch` enforces policy at launch time (`policy.decision` / `policy.denied` events).
- Budget preflight/advisory decisions are emitted before spawn (`budget.decision|budget.alert|budget.exceeded` with `phase=preflight`).
- Hard preflight budget exceedance marks the run failed and returns a launch error.

`run.replay` params:

- `workspace_dir` (required)
- `project_id` (required)
- `run_id` (required)
- `tail` (optional)
- `mode` (`raw|verified|deterministic|live`, optional; default `raw`)

`sharepack.replay` params:

- `workspace_dir` (required)
- `project_id` (required)
- `share_pack_id` (required)
- `run_id` (optional)
- `tail` (optional)
- `mode` (`raw|verified|deterministic`, optional; default `raw`)

`ui.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`ui.snapshot` response highlights:

- `index_sync_worker` runtime status
- `heartbeat` summary block (enabled/running, interval/top-k config, last/next tick, aggregate counters)
- `monitor`, `review_inbox`, `usage_analytics`, `colleagues`, `comments`

`ui.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`agent.refresh_context` params:

- `workspace_dir` (required)
- `agent_id` (required)
- `project_id` (optional filter)
- `max_tasks` (optional)
- `max_scope_paths` (optional)

`agent.self_improve_cycle` params:

- `workspace_dir` (required)
- `project_id` (required)
- `worker_agent_id` (required)
- `manager_actor_id` (required)
- `manager_role` (`human|ceo|director|manager|worker`)
- `mistake_key` (required)
- `summary` (required)
- `prevention_rule` (required)
- `proposal_threshold` (optional; integer >= 1)
- `promote_threshold` (optional; integer >= 1)
- `evidence_artifact_ids` (optional)
- `task_id` (optional)
- `milestone_id` (optional)
- `evaluation_argv` (optional command argv list for gate evaluation)
- `evaluation_repo_id` (optional)
- `evaluation_workdir_rel` (optional)
- `evaluation_env` (optional string map)

Result semantics:

- `status` can be:
  - `recorded_only` (mistake count below proposal threshold)
  - `already_guided` (worker AGENTS rule already present)
  - `evaluation_failed` (evaluation gate failed; failure artifact written)
  - `proposal_created` (pending memory delta proposal created for manager approval)

`comment.add` params:

- `workspace_dir` (required)
- `project_id` (required)
- `author_id` (required)
- `author_role` (`human|ceo|director|manager|worker`)
- `body` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `visibility` (optional; default `managers`)

`comment.list` params:

- `workspace_dir` (required)
- `project_id` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `limit` (optional)

`resources.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional)

`resources.snapshot` response highlights:

- `totals` includes `agents`, `workers`, `active_workers`, `runs_indexed`, token/cost totals, and provider-aware context-cycle totals
- `providers[]` includes `provider`, `run_count`, `total_tokens`, `total_cost_usd`
- `models[]` includes `model`, `agent_count`

`agent.profile.snapshot` params:

- `workspace_dir` (required)
- `agent_id` (required)
- `project_id` (optional)

`agent.profile.snapshot` response highlights:

- `agent` includes profile fields (`display_title`, `avatar`, `model_hint`) and `tenure_days`
- `metrics.context_cycles_count` is nullable
- `metrics.context_cycles_source` is `provider_signal|unknown`; clients must render unknown rather than fabricating values

`conversation.list` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)

`conversation.create_channel` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `name` (required)
- `slug` (required)
- `visibility` (optional)
- `created_by` (required)
- `participant_agent_ids` (optional)
- `participant_team_ids` (optional)

`conversation.create_dm` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `created_by` (required)
- `peer_agent_id` (required)
- `visibility` (optional)

`conversation.messages.list` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `conversation_id` (required)
- `limit` (optional)

`conversation.message.send` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)
- `conversation_id` (required)
- `author_id` (required)
- `author_role` (required)
- `body` (required)
- `kind` (optional)
- `visibility` (optional)
- `mentions` (optional)

`conversation.members.sync` params:

- `workspace_dir` (required)
- `project_id` (required)
- `ceo_actor_id` (optional)

`task.list` params:

- `workspace_dir` (required)
- `project_id` (required)

`task.update_plan` params:

- `workspace_dir` (required)
- `project_id` (required)
- `task_id` (required)
- `schedule` (optional)
- `schedule.planned_start` (optional ISO datetime)
- `schedule.planned_end` (optional ISO datetime)
- `schedule.duration_days` (optional positive integer)
- `schedule.depends_on_task_ids` (optional string array)
- `execution_plan` (optional)
- `execution_plan.preferred_provider` (optional)
- `execution_plan.preferred_model` (optional)
- `execution_plan.preferred_agent_id` (optional)
- `execution_plan.token_budget_hint` (optional non-negative integer)
- `execution_plan.applied_by` (optional)
- `execution_plan.applied_at` (optional ISO datetime)
- `clear_schedule` (optional boolean)
- `clear_execution_plan` (optional boolean)

`pm.snapshot` params:

- `workspace_dir` (required)
- `scope` (`workspace|project`, required)
- `project_id` (required for `scope=project`)

`pm.snapshot` response highlights:

- workspace scope includes portfolio summary and project PM rows
- project scope additionally includes:
  - `project.summary` (task counts + progress)
  - `project.gantt.cpm_status` (`ok|dependency_cycle`)
  - `project.gantt.tasks[]` task bars (`start_at`, `end_at`, `duration_days`, `slack_days`, `critical`)
- dependency cycles are surfaced in payload as status flags; snapshot generation does not crash

`pm.recommend_allocations` params:

- `workspace_dir` (required)
- `project_id` (required)

`pm.apply_allocations` params:

- `workspace_dir` (required)
- `project_id` (required)
- `applied_by` (required)
- `items` (required array)
- `items[].task_id` (required)
- `items[].preferred_provider` (optional)
- `items[].preferred_model` (optional)
- `items[].preferred_agent_id` (optional)
- `items[].token_budget_hint` (optional)

## Error Codes

- `-32700`: Parse error
- `-32600`: Invalid request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32000`: Application error
