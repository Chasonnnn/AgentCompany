# AgentCompany JSON-RPC Protocol v1 (Local Stdio)

This document defines the v1 control-plane contract for local clients.

## Transport

- Protocol: JSON-RPC 2.0
- Framing: one JSON object per line (`\n` delimited)
- Direction: bidirectional over stdio
- Server command: `ac server:start`

## Request/Response

Requests:

```json
{"jsonrpc":"2.0","id":1,"method":"run.list","params":{"workspace_dir":"/path/to/ws"}}
```

Success:

```json
{"jsonrpc":"2.0","id":1,"result":[{"project_id":"proj_x","run_id":"run_x"}]}
```

Error:

```json
{"jsonrpc":"2.0","id":1,"error":{"code":-32602,"message":"Invalid params","data":[...]}}
```

## Notification Stream

Server notifications use:

```json
{"jsonrpc":"2.0","method":"events.notification","params":{"subscription_id":"sub_x","project_id":"proj_x","event":{...}}}
```

`event` payload mirrors persisted run events from `events.jsonl`.

## Supported Methods (v1)

Workspace:

- `workspace.open`
- `workspace.init`
- `workspace.validate`
- `workspace.doctor`

Run/session:

- `run.create`
- `run.list`
- `run.replay`
- `session.launch`
- `session.list`
- `session.poll`
- `session.collect`
- `session.stop`

Inbox/governance:

- `inbox.list_reviews`
- `inbox.list_help_requests`
- `memory.propose_delta`
- `memory.approve_delta`
- `milestone.approve`
- `agent.record_mistake`

Adapters:

- `adapter.status`

Index/cache:

- `index.rebuild`
- `index.stats`
- `index.list_runs`
- `index.list_events`
- `index.list_event_parse_errors`
- `index.list_reviews`
- `index.list_help_requests`

Run monitor:

- `monitor.snapshot`

Event subscriptions:

- `events.subscribe`
- `events.unsubscribe`
- `events.ack`

## Event Subscription Params

`events.subscribe` params:

- `subscription_id` (optional)
- `workspace_dir` (optional; required for indexed backfill)
- `project_id` (optional filter)
- `run_id` (optional filter)
- `event_types` (optional array filter)
- `backfill_limit` (optional; if provided with `workspace_dir`, replays recent indexed events in ascending order)

`events.unsubscribe` params:

- `subscription_id` (required)

`events.ack` params:

- `subscription_id` (required)
- `last_ack_ts_monotonic_ms` (optional)

## Error Codes

- `-32700`: Parse error
- `-32600`: Invalid request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32000`: Application error
