# AgentCompany JSON-RPC Protocol v1 (Local Stdio)

This document defines the v1 control-plane contract for local clients.

## Transport

- Protocol: JSON-RPC 2.0
- Framing: one JSON object per line (`\n` delimited)
- Direction: bidirectional over stdio
- Server command: `ac server:start`

## Request/Response

Requests:

```json
{"jsonrpc":"2.0","id":1,"method":"run.list","params":{"workspace_dir":"/path/to/ws"}}
```

Success:

```json
{"jsonrpc":"2.0","id":1,"result":[{"project_id":"proj_x","run_id":"run_x"}]}
```

Error:

```json
{"jsonrpc":"2.0","id":1,"error":{"code":-32602,"message":"Invalid params","data":[...]}}
```

## Notification Stream

Server notifications use:

```json
{"jsonrpc":"2.0","method":"events.notification","params":{"subscription_id":"sub_x","project_id":"proj_x","event":{...}}}
```

`event` payload mirrors persisted run events from `events.jsonl`.

Run lifecycle streams may include usage events:

- `usage.reported`: provider-reported token counters extracted from structured provider output
- `usage.estimated`: deterministic fallback estimated from character counts when provider usage is unavailable

Terminal `run.yaml` now includes optional `usage` with normalized token counters and confidence.

Provider note:
- Claude driver now runs with `--output-format stream-json`; clients should expect `provider.raw` chunks to include JSONL stream events.

## Supported Methods (v1)

Workspace:

- `workspace.open`
- `workspace.init`
- `workspace.validate`
- `workspace.doctor`
- `workspace.export`
- `workspace.import`

Run/session:

- `worktree.cleanup`
- `run.create`
- `run.list`
- `run.replay`
- `session.launch`
- `session.list`
- `session.poll`
- `session.collect`
- `session.stop`

Inbox/governance:

- `inbox.list_reviews`
- `inbox.list_help_requests`
- `inbox.snapshot`
- `inbox.resolve`
- `artifact.read`
- `memory.propose_delta`
- `memory.approve_delta`
- `milestone.approve`
- `agent.record_mistake`
- `agent.refresh_context`

Adapters:

- `adapter.status`

Index/cache:

- `index.rebuild`
- `index.sync`
- `index.stats`
- `index.sync_worker_status`
- `index.sync_worker_flush`
- `index.list_runs`
- `index.list_events`
- `index.list_event_parse_errors`
- `index.list_reviews`
- `index.list_help_requests`

Run monitor:

- `monitor.snapshot`
- `ui.snapshot`
- `ui.resolve`
- `comment.add`
- `comment.list`

Event subscriptions:

- `events.subscribe`
- `events.unsubscribe`
- `events.ack`

## Event Subscription Params

`events.subscribe` params:

- `subscription_id` (optional)
- `workspace_dir` (optional; required for indexed backfill)
- `project_id` (optional filter)
- `run_id` (optional filter)
- `event_types` (optional array filter)
- `backfill_limit` (optional; if provided with `workspace_dir`, server runs incremental index sync then replays recent events in ascending order)

`events.unsubscribe` params:

- `subscription_id` (required)

`events.ack` params:

- `subscription_id` (required)
- `last_ack_ts_monotonic_ms` (optional)

`monitor.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`workspace.doctor` params:

- `workspace_dir` (required)
- `rebuild_index` (optional; full rebuild check/fix)
- `sync_index` (optional; incremental sync check/fix)

`workspace.export` params:

- `workspace_dir` (required)
- `out_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`workspace.import` params:

- `src_dir` (required)
- `workspace_dir` (required)
- `include_local` (optional; default false)
- `force` (optional; default false)

`worktree.cleanup` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `max_age_hours` (optional; default 72)
- `dry_run` (optional; default false)

`index.sync_worker_status` params:

- none

`index.sync_worker_flush` params:

- none

`inbox.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`inbox.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)

`session.poll` / `session.collect` / `session.stop` params:

- `session_ref` (required)
- `workspace_dir` (optional; needed when resolving persisted sessions after runtime restart)

`ui.snapshot` params:

- `workspace_dir` (required)
- `project_id` (optional filter)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`ui.resolve` params:

- `workspace_dir` (required)
- `project_id` (required)
- `artifact_id` (required)
- `decision` (`approved` or `denied`)
- `actor_id` (required)
- `actor_role` (`human|ceo|director|manager|worker`)
- `actor_team_id` (optional)
- `notes` (optional)
- `monitor_limit` (optional)
- `pending_limit` (optional)
- `decisions_limit` (optional)
- `refresh_index` (optional; full rebuild)
- `sync_index` (optional; incremental sync, default true when index exists)

`agent.refresh_context` params:

- `workspace_dir` (required)
- `agent_id` (required)
- `project_id` (optional filter)
- `max_tasks` (optional)
- `max_scope_paths` (optional)

`comment.add` params:

- `workspace_dir` (required)
- `project_id` (required)
- `author_id` (required)
- `author_role` (`human|ceo|director|manager|worker`)
- `body` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `visibility` (optional; default `managers`)

`comment.list` params:

- `workspace_dir` (required)
- `project_id` (required)
- `target_agent_id` (optional)
- `target_artifact_id` (optional)
- `target_run_id` (optional)
- `limit` (optional)

## Error Codes

- `-32700`: Parse error
- `-32600`: Invalid request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32000`: Application error
